\def\layersep{1.2cm}
\def\nodeinlayersep{0.8cm}


\begin{figure}[H]
\centering
\begin{tikzpicture}[
    node distance=\layersep,
    edge/.style={-stealth,shorten >=1pt, draw=black!50,thin},
    neuron/.style={circle,fill=black!25,minimum size=10pt,inner sep=0pt},
    operator/.style={rectangle,fill=green!,minimum height= \nodeinlayersep, minimum width= 0.8 * \layersep, inner sep=0pt, rounded corners},
    input neuron/.style={neuron, fill=green!50,minimum size=16pt},
    output neuron/.style={neuron, fill=green!50,minimum size=12pt},
    hidden neuron/.style={neuron, fill=blue!50},
    Forward map/.style={operator, fill=red!50},
    annot/.style={text width=4em, text centered},
    every node/.style={scale=1.0},
    node1/.style={scale=2.0}
]
    % Draw the input layer nodes
    \foreach \name / \y in {1,...,4}
        {\ifnum \y=3
            \node (I-\name) at (0,-\nodeinlayersep * \y - \nodeinlayersep * 0.5) {$\vdots$};
            % \node[input neuron] (I-\name) at (0,-\y-0.4) {$y_{\y}$};
        \else
            \ifnum \y=4
                \node[input neuron] (I-\name) at (0,-\nodeinlayersep * \y - \nodeinlayersep * 0.5) {$u_{m}$};
            \else
                \node[input neuron] (I-\name) at (0,-\nodeinlayersep *\y - \nodeinlayersep * 0.5 ) {$u_{\y}$};
            \fi
        \fi}
        
    % Draw the output layer node
    \foreach \name / \y in {1,...,4}
        {\ifnum \y=3
            \node (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 0.5) {$\vdots$};
            % \node[input neuron] (I-\name) at (0,-\y-0.4) {$y_{\y}$};
        \else
            \ifnum \y=4
                \node[input neuron] (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 0.5) {$y_{n}^*$};
            \else
                \node[input neuron] (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 0.5) {$y_{\y}^*$};
            \fi
        \fi}
        
    % Forward map
    \node[Forward map] (FM) at (9*\layersep,-\nodeinlayersep * 3.) {$\mathcal{G}$};
    
    % Predicted observations 
    \foreach \name / \y in {1,...,4}
        {\ifnum \y=3
            \node (obs_p-\name) at (10*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 0.5) {$\vdots$};
        \else
            \ifnum \y=4
                \node[input neuron] (obs_p-\name) at (10*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * .5) {$y_{n}^{**}$};
            \else
                \node[input neuron] (obs_p-\name) at (10*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * .5) {$y_{\y}^{**}$};
            \fi
        \fi}    
    
    % Predicted observations - Decoder
    \foreach \name / \y in {1,...,4}
        {\ifnum \y=3
            \node (obs_p-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5) {$\vdots$};
        \else
            \ifnum \y=4
                \node[input neuron] (obs_p2-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5 ) {$u_{m}^{*}$};
            \else
                \node[input neuron] (obs_p2-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5) {$u_{\y}^{*}$};
            \fi
        \fi}    
        
    % Set number of Encoder hidden layers
    \newcommand \Nhidden{3}
    % Draw Encoder 
    \foreach \N in {1,...,\Nhidden} {
        \foreach \y in {1,...,5} { %%% MODIFIED (1,...,12 -> 1,...,5, and the next five lines)
            \ifnum \y=4
                \node at (\N*\layersep,-\y*\nodeinlayersep) {$\vdots$};
            \else
                \node[hidden neuron] (H\N-\y) at (\N*\layersep,-\y*\nodeinlayersep ) {$\sigma$};
        \fi
      }
    }    
    
    % Draw Decoder
    \foreach \N in {1,...,\Nhidden} {
        \foreach \y in {1,...,5} { %%% MODIFIED (1,...,12 -> 1,...,5, and the next five lines)
            \ifnum \y=4
                \node at (\N*\layersep + 4*\layersep,-\y*\nodeinlayersep - 0*\nodeinlayersep) {$\vdots$};
            \else
                \node[hidden neuron] (D\N-\y) at (\N*\layersep + 4*\layersep ,-\y*\nodeinlayersep + 0*\nodeinlayersep) {$\sigma$};
        \fi
      }
    }        
        
    
    
    %%% <-- MODIFIED (from H\Nhidden-6 to H\Nhidden-3) 
    % Connect every node in Inputs to Encoder
    \foreach \source in {1,2,4}
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
            \draw[edge] (I-\source) -- (H1-\dest);
    
    % connect all Encoder
    \foreach [remember=\N as \lastN (initially 1)] \N in {2,...,\Nhidden}
      \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
          \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
              \draw[edge] (H\lastN-\source) -- (H\N-\dest);
              
    % Connect every node in the Encoder to output
    \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,2,4}
            \draw[edge] (H\Nhidden-\source) -- (O-\dest);
    
    % Connect to the forward operator
    \foreach \source in {1,2,4}
        \draw[edge] (obs_p2-\source) -- (FM);
        
    % Connect to the forward operator
    \foreach \source in {1,2,4}
        \draw[edge] (FM) -- (obs_p-\source);    
    
    % Connect every node in the observed output to Decoder
    \foreach \source in {1,2,4}
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
            \draw[edge] (O-\source) -- (D1-\dest);
            
    % connect all Decoder 
    \foreach [remember=\N as \lastN (initially 1)] \N in {2,...,\Nhidden}
      \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
          \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
              \draw[edge] (D\lastN-\source) -- (D\N-\dest);
    
    
    % Connect every node in the Decoder to output
    \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,2,4}
            \draw[edge] (D\Nhidden-\source) -- (obs_p2-\dest);
    
    
           
    % Pink Loss term
    \node[rectangle,fill=pink!40,minimum height= \nodeinlayersep, minimum width= 0.8 * \layersep, rounded corners] (L_misfit) at (7*\layersep, -6.6*\nodeinlayersep) {Loss $\mathcal{L}:= \halfv{\beta} \nor{\yb - \yb^*}^2 + \half \nor{\ub - \ub^*}^2 + \halfv{\alpha} \nor{\yb - \yb^{**}}^2$};
    
    % From predicted parameter to Loss term
    \draw [decorate, decoration = {calligraphic brace,mirror}, thick] (3.85*\layersep,-4.9*\nodeinlayersep) -- (4.15*\layersep,-4.9*\nodeinlayersep);
    \draw[edge,thin] (4*\layersep,-5.1*\nodeinlayersep) -- (4*\layersep, -6.1*\nodeinlayersep);
    % -- (L_misfit);

    % From predicted obs to Loss term
    \draw [decorate, decoration = {calligraphic brace,mirror}, thick] (7.85*\layersep,-4.9*\nodeinlayersep) -- (8.15*\layersep,-4.9*\nodeinlayersep);
    \draw[edge,thin] (8*\layersep,-5.1*\nodeinlayersep) -- (8*\layersep, -6.1*\nodeinlayersep);
    % -- (6.50*\layersep, -6.4*\nodeinlayersep);
    
    % From predicted obs to Loss term
    \draw [decorate, decoration = {calligraphic brace,mirror}, thick] (9.85*\layersep,-4.9*\nodeinlayersep) -- (10.15*\layersep,-4.9*\nodeinlayersep);
    \draw[edge,thin] (10*\layersep,-5.1*\nodeinlayersep) -- (10*\layersep, -6.1*\nodeinlayersep);
    % -- (6.50*\layersep, -6.6*\nodeinlayersep);
    
    
    % bracket for deep neural network
    \draw [decorate, decoration = {calligraphic brace}, thick] (.85*\layersep,-0.7*\nodeinlayersep) -- (3.15*\layersep,-.7*\nodeinlayersep) node[pos=0.5,above=0.1cm,black]{Encoder};
    
    \draw [decorate, decoration = {calligraphic brace}, thick] (4.85*\layersep,-0.7*\nodeinlayersep) -- (7.15*\layersep,-.7*\nodeinlayersep) node[pos=0.5,above=0.1cm,black]{Decoder};
    
    \draw [decorate, decoration = {calligraphic brace}, thick] (7.85*\layersep,-0.7*\nodeinlayersep) -- (10.15*\layersep,-.7*\nodeinlayersep) node[pos=0.5,above=0.1cm,black]{Model-constrained};
    
\end{tikzpicture}
\caption{Model-constrained Decoder (\mcDEC{}) deep neural network architecture. The PoI $\ub$ is fed into the encoder $\Psi_e$. The observation $\yb^*$ predicted by the encoder is fed back to the decoder  $\Psi_d$ to generate PoI $\ub^*$, which is then pushed through the PtO map $\F$ to  generate the another predicted observations $\yb^{**}$. Both predicted parameters and two observation sets are compared with ground truth $\ub$ and $\yb$, respectively, to provide the mean-square error in the loss function $\mc{L}$.}
\figlab{mcDEC_architecture}
\end{figure}


