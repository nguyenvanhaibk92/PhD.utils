\frame{
    \frametitle{Model-constrained Autoencoder ($\mcOPO$) - embedding physics model}
\def\layersep{1.7cm}
\def\nodeinlayersep{1.cm}
% Define UT orange using RGB values
\definecolor{utorange}{RGB}{255,130,0}

\begin{figure}[htb!]
        \centering
\resizebox{0.7\textwidth}{!}{
        \begin{tikzpicture}[
            node distance=\layersep,
            edge/.style={-stealth,shorten >=1pt, draw=black!50,thin},
            neuron/.style={circle,fill=black!25,minimum size=10pt,inner sep=0pt},
            operator/.style={rectangle,fill=green!,minimum height= \nodeinlayersep, minimum width= 0.8 * \layersep, inner sep=0pt, rounded corners},
            input noise/.style={neuron, draw = black, fill=gray!50,minimum size=16},
            input neuron/.style={neuron, draw = black, fill=green!10,minimum size=16},
            output neuron/.style={neuron, draw = black, fill=utorange!50,minimum size=16pt},
            hidden neuron/.style={neuron, draw = black, fill=utorange!10, minimum size=16pt},
            Forward map/.style={operator, draw = black, fill=utorange!100},
            annot/.style={text width=4em, text centered},
            every node/.style={scale=1.0},
            node1/.style={scale=2.0}
        ]
        % Draw the input layer nodes
        \foreach \name / \y in {1,...,4}
            {\ifnum \y=3
                    \node (I-\name) at (-.8 * \layersep,-\nodeinlayersep * \y - \nodeinlayersep * 2.) {$\vdots$};
                \else
                    \ifnum \y=4
                        \node[input noise] (I-\name) at (-.8 * \layersep,-\nodeinlayersep * \y - \nodeinlayersep * 2.) {$\epsilon_{\dy}$};
                    \else
                        \node[input noise] (I-\name) at (-.8 * \layersep,-\nodeinlayersep *\y - \nodeinlayersep * 2. ) {$\epsilon_{\y}$};
                    \fi
                \fi}
        
        % Draw the input layer nodes
        \foreach \name / \y in {1,...,4}
            {\ifnum \y=3
                    \node (I-\name) at (0,-\nodeinlayersep * \y - \nodeinlayersep * 2.) {$\vdots$};
                    % \node[input neuron] (I-\name) at (0,-\y-0.4) {$y_{\y}$};
                \else
                    \ifnum \y=4
                        \node[input neuron] (I-\name) at (0,-\nodeinlayersep * \y - \nodeinlayersep * 2.) {$y_{\dy}$};
                    \else
                        \node[input neuron] (I-\name) at (0,-\nodeinlayersep *\y - \nodeinlayersep * 2. ) {$y_{\y}$};
                    \fi
                \fi}

        % Draw the output layer node
        \foreach \name / \y in {1,...,4}
            {\ifnum \y=3
                    \node (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 2.) {$\vdots$};
                    % \node[input neuron] (I-\name) at (0,-\y-0.4) {$y_{\y}$};
                \else
                    \ifnum \y=4
                        \node[input neuron] (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 2.) {$u_{\du}^*$};
                    \else
                        \node[input neuron] (O-\name) at (4*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 2.) {$u_{\y}^*$};
                    \fi
                \fi}

        % Forward map
        \node[Forward map] (FM) at (5.5*\layersep,-\nodeinlayersep * 7.) {$\G$};

        % Predicted observations 
        \foreach \name / \y in {1,...,4}
            {\ifnum \y=3
                    \node (obs_p-\name) at (8*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 4.5) {$\vdots$};
                \else
                    \ifnum \y=4
                        \node[input neuron] (obs_p-\name) at (8*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 4.5) {$\omega_{\dw}^{'}$};
                    \else
                        \node[input neuron] (obs_p-\name) at (8*\layersep,-\nodeinlayersep *\y - \nodeinlayersep * 4.5) {$\omega_{\y}^{'}$};
                    \fi
                \fi}

        % Predicted observations - Decoder
        \foreach \name / \y in {1,...,4}
            {\ifnum \y=3
                    \node (obs_p-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5) {$\vdots$};
                \else
                    \ifnum \y=4
                        \node[input neuron] (obs_p2-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5 ) {$\omega_{\dw}^{*}$};
                    \else
                        \node[input neuron] (obs_p2-\name) at (8*\layersep,-\nodeinlayersep *\y + \nodeinlayersep * -.5) {$\omega_{\y}^{*}$};
                    \fi
                \fi}

        % Set number of Encoder hidden layers
        \newcommand \Nhidden{3}
        % Draw Encoder 
        \foreach \N in {1,...,\Nhidden} {
                \foreach \y in {1,...,5} { %%% MODIFIED (1,...,12 -> 1,...,5, and the next five lines)
                        \ifnum \y=4
                            \node at (\N*\layersep,-\y*\nodeinlayersep-1.5*\nodeinlayersep) {$\vdots$};
                        \else
                            \node[hidden neuron] (H\N-\y) at (\N*\layersep,-\y*\nodeinlayersep-1.5*\nodeinlayersep) {$\sigma$};
                        \fi
                    }
            }

        % Draw Decoder
        \foreach \N in {1,...,\Nhidden} {
                \foreach \y in {1,...,5} { %%% MODIFIED (1,...,12 -> 1,...,5, and the next five lines)
                        \ifnum \y=4
                            \node at (\N*\layersep + 4*\layersep,-\y*\nodeinlayersep - 0*\nodeinlayersep) {$\vdots$};
                        \else
                            \node[hidden neuron] (D\N-\y) at (\N*\layersep + 4*\layersep ,-\y*\nodeinlayersep + 0*\nodeinlayersep) {$\sigma$};
                        \fi
                    }
            }



        %%% <-- MODIFIED (from H\Nhidden-6 to H\Nhidden-3) 
        % Connect every node in Inputs to Encoder
        \foreach \source in {1,2,4}
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \draw[edge] (I-\source) -- (H1-\dest);

        % connect all Encoder
        \foreach [remember=\N as \lastN (initially 1)] \N in {2,...,\Nhidden}
        \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \draw[edge] (H\lastN-\source) -- (H\N-\dest);

        % Connect every node in the Encoder to output
        \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,2,4}
        \draw[edge] (H\Nhidden-\source) -- (O-\dest);

        % Connect to the forward operator
        \foreach \source in {1,2,4}
        \draw[edge] (O-\source) -- (5.1*\layersep,-\nodeinlayersep * 7.);

        % Connect to the forward operator
        \foreach \source in {1,2,4}
        \draw[edge] (FM) -- (obs_p-\source);

        % Connect every node in the observed output to Decoder
        \foreach \source in {1,2,4}
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \draw[edge] (O-\source) -- (D1-\dest);

        % connect all Decoder 
        \foreach [remember=\N as \lastN (initially 1)] \N in {2,...,\Nhidden}
        \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \draw[edge] (D\lastN-\source) -- (D\N-\dest);


        % Connect every node in the Decoder to output
        \foreach \source in {1,...,3,5} %%% <-- MODIFIED (1,...,12 -> 1...,3,5)
        \foreach \dest in {1,2,4}
        \draw[edge] (D\Nhidden-\source) -- (obs_p2-\dest);



        % Pink Loss term
        \node[rectangle,draw = black,fill=orange!10,minimum height= \nodeinlayersep, minimum width= 4. * \layersep, rounded corners] (L_misfit) at (7.4*\layersep, 1.*\nodeinlayersep) { Loss $\mathcal{L}\,\, = \,\, \half \nor{\ybfull^{*} - \ybfull^{'}}_2^2$};

        % From predicted pred Decoder to Loss term
        \draw [decorate, decoration = {calligraphic brace}, thin] (8.25*\layersep,-1.2*\nodeinlayersep) -- (8.25*\layersep,-4.8*\nodeinlayersep);

        \draw[edge,thin] (8.35*\layersep,-3.0*\nodeinlayersep) -- (8.9*\layersep, -3*\nodeinlayersep) -- (8.9*\layersep, .5*\nodeinlayersep);

        % From predicted Forward to Loss term
        \draw [decorate, decoration = {calligraphic brace}, thin] (8.25*\layersep,-5.2*\nodeinlayersep) -- (8.25*\layersep,-8.8*\nodeinlayersep);
        \draw[edge,thin] (8.35*\layersep,-6.95*\nodeinlayersep) -- (9*\layersep, -6.95*\nodeinlayersep) -- (9*\layersep, .5*\nodeinlayersep);
        % \draw[edge,thin] (8.35*\layersep,-7.05*\nodeinlayersep) -- (9*\layersep, -7.05*\nodeinlayersep) -- (9*\layersep, -10.*\nodeinlayersep);

        % From predicted parameter to Loss term
        % \draw [decorate, decoration = {calligraphic brace}, thin] (4.15*\layersep,-6.5*\nodeinlayersep) -- (3.85*\layersep,-6.5*\nodeinlayersep);
        % \draw[edge,thin] (4*\layersep,-6.6 *\nodeinlayersep) -- (4*\layersep, -10 *\nodeinlayersep);
        
        \draw [decorate, decoration = {calligraphic brace}, thick] (.85*\layersep,-2.*\nodeinlayersep) -- (3.15*\layersep,-2.*\nodeinlayersep) node[pos=0.5,above=0.1cm,black]{Pre-trained Encoder $\Psie^*$};

        \draw [decorate, decoration = {calligraphic brace}, thick] (4.85*\layersep,-0.5*\nodeinlayersep) -- (7.15*\layersep,-.5*\nodeinlayersep) node[pos=0.5,above=0.1cm,black]{Decoder $\Psid$};

        \draw [decorate, decoration = {calligraphic brace, mirror}, thick] (5*\layersep,-9.*\nodeinlayersep) -- (8.25*\layersep,-9.*\nodeinlayersep) node[pos=0.5,above=0.cm,black]{Model-constrained};

        % \node[rectangle,draw = black,fill=orange!10,minimum height= \nodeinlayersep, minimum width= 0.8 * \layersep, rounded corners] (L_misfit_2) at (6.5*\layersep, -10.5*\nodeinlayersep) {\textbf{Phase 1}: Loss $\mathcal{L}_e:= \halfv{1} \nor{\ub - \ub^*}_2^2 + \halfv{\lambda} \nor{\yb - \B \ybfull^{'}}_2^2$};

        % Randomize machine engine
        \node[rectangle,fill=gray!40,minimum height= \nodeinlayersep, minimum width= 1.6 * \layersep, rounded corners] (random_noise_engine) at (1.4*\layersep, -10.*\nodeinlayersep) {\begin{tabular}{c} Random noise \vspace*{.2cm} \\  $\epsb \sim \mc{N} \LRp{\mathbf{0}, \epsilon^2 \LRs{\boldsymbol{\diag}\LRp{{\yb}}}^2}$ \end{tabular}};
        \draw[edge,thin] (random_noise_engine) -- (-.8*\layersep, -10. *\nodeinlayersep) -- (-.8*\layersep, -6.6 *\nodeinlayersep);

        % Horizontal line of the plus sign
        \draw[line width=3pt] (-0.55*\layersep, -4.6*\nodeinlayersep) -- (-0.25*\layersep, -4.6*\nodeinlayersep);

        % Vertical line of the plus sign
        \draw[line width=3pt] (-0.4*\layersep, -4.3*\nodeinlayersep) -- (-0.4*\layersep, -4.9*\nodeinlayersep);
        
        \draw[draw=white] (-1.5*\layersep, 2.*\nodeinlayersep) rectangle (9.5*\layersep, -11.5*\nodeinlayersep);
        
    \end{tikzpicture}
}
\end{figure}
}